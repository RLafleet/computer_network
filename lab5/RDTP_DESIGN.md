# Документ по проектированию RDTP

## 1. Назначение

RDTP — учебный протокол надежной передачи данных поверх UDP. Реализованы две схемы ARQ: Go-Back-N (GBN) и Selective Repeat (SR). Протокол поддерживает скользящее окно, адаптивный таймаут по RTT, симуляцию потерь/задержек/ошибок CRC и два режима вывода: обычный и отладочный.

## 2. Формат пакета

Формат фиксированного заголовка (16 байт) + полезная нагрузка:

| Поле | Размер | Описание |
|------|--------|----------|
| seq  | 32 бита | номер последовательности (пакетный, а не байтовый) |
| ack  | 32 бита | номер подтверждения |
| flags| 16 бит | флаги ACK/SYN/FIN/DATA |
| len  | 16 бит | длина данных |
| crc32| 32 бита | контрольная сумма CRC32 |
| data | len | данные |

CRC32 считается по всему пакету (заголовок + данные) при условии, что поле `crc32` в заголовке обнулено. Для контроля целостности используется полиномиальная CRC32.

Флаги:
- `ACK` — подтверждение
- `SYN` — служебный пакет начала (размер файла)
- `FIN` — завершение передачи
- `DATA` — данные файла

Передача начинается с `SYN` (payload = 8 байт размера файла в сетевом порядке), затем идут `DATA` с последовательными номерами и завершается `FIN`.

## 3. Конечные автоматы (FSM)

### 3.1. Отправитель

Состояния логически можно описать как:

1. **Инициализация**: чтение файла, разбиение на сегменты, подготовка окна.
2. **Передача**: отправка новых пакетов в пределах окна.
3. **Ожидание ACK**: ожидание подтверждений или таймаутов.
4. **Повтор**: при таймауте — повторная передача (в GBN — всего окна, в SR — только истекшего пакета).
5. **Завершение**: после ACK на `FIN` и подтверждения всех пакетов.

Переходы:
- `init → transmit` после подготовки сегментов.
- `transmit → wait_ack` после заполнения окна.
- `wait_ack → transmit` после подтверждений (сдвиг окна).
- `wait_ack → retransmit` при таймауте.
- `retransmit → wait_ack` после повторной отправки.
- `wait_ack → done` после подтверждения всех сегментов.

### 3.2. Получатель

1. **Ожидание пакетов**: прием сегментов.
2. **Проверка CRC**: отбрасывание поврежденных пакетов.
3. **Упорядочивание**:
   - GBN: принимаются только пакеты с ожидаемым seq.
   - SR: пакеты буферизуются в окне и выдаются по порядку.
4. **Запись в файл**: для DATA.
5. **Завершение**: получение `FIN` и запись всех данных.

Переходы:
- `wait_packet → validate → (deliver/buffer)`
- `deliver → send_ack` для каждого принятого сегмента
- `buffer → deliver` при замыкании последовательности
- `deliver FIN → done`

## 4. Алгоритмы ARQ

### 4.1. Go-Back-N (GBN)

- Отправитель хранит `base` (первый неподтвержденный) и `next` (следующий к отправке).
- При таймауте повторно отправляется все окно `[base, next)`.
- Получатель принимает только `seq == expected` и отправляет кумулятивный ACK (`ack = expected`).
- Дубликаты ACK учитываются как статистика.

### 4.2. Selective Repeat (SR)

- Отправитель отслеживает подтверждения по каждому пакету отдельно.
- Таймаут срабатывает отдельно для каждого сегмента в окне.
- Получатель буферизует пакеты в окне и подтверждает каждый `seq` отдельно.
- Данные записываются в файл при непрерывной последовательности от `base`.

## 5. Скользящее окно и адаптивные таймауты

Окно задается параметром `-w`. Для SR приемник хранит буфер размером окна. Таймауты рассчитываются адаптивно на основе измерений RTT (по подтверждениям не-переотправленных пакетов, аналог Karn).

Используется классическая формула:

- `SRTT = (1-α) * SRTT + α * RTT`
- `RTTVAR = (1-β) * RTTVAR + β * |RTT - SRTT|`
- `RTO = SRTT + 4 * RTTVAR`

где `α=1/8`, `β=1/4`, RTO ограничивается диапазоном 100–2000 мс.

## 6. Адаптивное управление окном (доп.)

Опционально поддерживается режим `-cc`:

- Старт с `cwnd = 1` (медленный старт).
- Пока `cwnd < ssthresh` — линейный рост на каждый ACK.
- После достижения `ssthresh` — избегание перегрузок (`cwnd += 1/cwnd`).
- При таймауте: `ssthresh = cwnd/2`, `cwnd = 1`.

Логи изменения окна пишутся в файл при использовании `-cwndlog`.

## 7. Симуляция ненадежного канала

В обоих участниках реализована имитация:

- потерь пакетов (`-loss pct`),
- случайных задержек (`-delay ms`, равномерный джиттер 0..ms),
- повреждений (`-corrupt pct`, приводит к ошибке CRC).

Симуляция применяется к исходящим пакетам отправителя и получателя, что позволяет моделировать потери как DATA, так и ACK.

## 8. Вывод и обработка ошибок

- Обычный режим: прогресс передачи и итоговая статистика.
- Отладочный режим (`-d`): события отправки, получения ACK, таймауты, повторные передачи, повреждения.
- Потеря соединения фиксируется при множественных таймаутах (sender) или длительном отсутствии данных (receiver).

## 9. Модульная структура

- `rdt_common.{h,c}` — формат пакета, CRC32, симуляция канала, RTT, логирование.
- `rdt_sender.c` — отправитель с поддержкой GBN/SR.
- `rdt_receiver.c` — получатель с поддержкой GBN/SR.
- `Makefile` — сборка.
