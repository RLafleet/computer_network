# Отчёт: UDP Pinger (клиент + сервер)

## Описание алгоритма

Клиент и сервер работают поверх UDP. Клиент последовательно отправляет 10 запросов, каждый из которых содержит номер пакета и метку времени отправки в миллисекундах. Сервер принимает датаграммы и, если они не «потеряны» в рамках симуляции, немедленно отправляет обратно тот же текст (эхо). Клиент ожидает ответ не более 1 секунды и для каждой успешной пары запрос–ответ рассчитывает RTT (Round‑Trip Time).

### Расчёт RTT и обработка таймаутов

1. **Подготовка сокета:** клиент создаёт UDP‑сокет и устанавливает таймаут приёма с помощью `setsockopt(..., SO_RCVTIMEO, ...)` на 1 секунду. Это позволяет `recvfrom()` автоматически завершаться с ошибкой `EAGAIN/EWOULDBLOCK`, если ответа нет.
2. **Отправка:** перед `sendto()` фиксируется текущее время `t_send` в миллисекундах (функция `gettimeofday()` + пересчёт в ms). Формируется строка `Ping <seq> <t_send>`.
3. **Ожидание ответа:** `recvfrom()` блокируется максимум на 1 секунду. Если ответ получен, фиксируется `t_recv` и RTT вычисляется как `(t_recv - t_send)`.
4. **Вывод:** для успешного ответа клиент печатает строку:
   `PING sequence_number timestamp, RTT = X.XXX сек`
   Если время ожидания превышено — выводится сообщение о таймауте на русском языке.
5. **Статистика (опция `-stats`):** после 10 пакетов считаются минимум, максимум и среднее RTT, а также процент потерь.

Точность RTT — миллисекунды, однако выводится он в секундах с тремя знаками после запятой (формат `%.3f`), что соответствует требованиям задания.

### Формат сообщений и логика эхо‑сервера

Формат сообщений клиента:

```
Ping <sequence_number> <timestamp_ms>
```

Сервер:

- принимает датаграмму;
- обновляет время последнего полученного пакета (для heartbeat‑мониторинга);
- случайно «теряет» пакет с вероятностью `-loss N` (если включено);
- в случае успеха отправляет ровно ту же строку обратно отправителю.

Симуляция потерь реализована простым сравнением `rand() % 100` с заданным процентом. Это позволяет демонстрировать «пропуски» и корректность обработки таймаутов на клиенте.

### Heartbeat‑мониторинг

**Клиент:** при включении флага `-hb` после завершения 10 пингов начинается периодическая отправка пакетов вида `Heartbeat <timestamp_ms>`. Интервал по умолчанию — 2 секунды (настраивается через `-hb-interval`). Режим завершается по `Ctrl+C`.

**Сервер:** отслеживает время последнего пакета. Если с момента последней активности проходит больше `N` секунд (по умолчанию 5, настраивается `-hb-timeout`), сервер печатает предупреждение о неактивном клиенте. При следующем получении пакета сервер сообщает, что клиент снова активен.

## Примеры вывода

### Успешные ping‑ответы

Клиент:

```
PING 1 1736178200123, RTT = 0.004 сек
PING 2 1736178201124, RTT = 0.003 сек
PING 3 1736178202125, RTT = 0.005 сек
...
```

### Демонстрация потерь

Сервер (с `-loss 30`):

```
UDP Pinger сервер запущен на порту 12000
Симуляция потерь: 30%
Таймаут heartbeat: 5 сек
```

Клиент:

```
PING 1 1736178200123, RTT = 0.006 сек
Таймаут ожидания
PING 3 1736178202125, RTT = 0.004 сек
Таймаут ожидания
...
```

### Расширенная статистика

```
--- Статистика ping ---
Отправлено: 10, Получено: 7, Потеряно: 3 (30%)
RTT: мин = 0.003с, макс = 0.018с, сред = 0.007с
```

### Heartbeat‑мониторинг

Сервер (после остановки клиента на >5 секунд):

```
Предупреждение: клиент неактивен более 5 сек
```

После возобновления пакетов:

```
Клиент снова активен
```
