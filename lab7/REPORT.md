# Отчёт: HTTP Web Proxy с кэшированием

## Описание алгоритма

Прокси-сервер принимает TCP‑подключения от клиентов, читает HTTP‑запрос, извлекает метод, URL, заголовки и при необходимости тело. Для `GET` строится канонический URL вида:

```
http://<host>:<port><path>
```

Далее выполняются шаги:

1. Проверка кэша по хеш‑ключу от URL.
2. Если объект свежий — ответ отдается из кэша без обращения к серверу.
3. Если объект устарел — выполняется условный `GET` (If-Modified-Since/If-None-Match).
4. Если сервер отвечает `304 Not Modified`, берется кэшированный объект, а метаданные обновляются.
5. Если ответ `200 OK`, данные проксируются клиенту и (если разрешено) сохраняются в кэш.

Для `POST` запросы проксируются на сервер без кэширования ответа.

## Формат кэша и структура хранения

Кэш хранится в каталоге `cache_dir` (по умолчанию `./cache`). Имя файла формируется из 64‑битного FNV‑1a хеша URL:

- `<hash>.cache` — полный ответ сервера (статусная строка + заголовки + тело).
- `<hash>.meta` — метаданные:

```
stored_at=<unix_ts>
expires=<unix_ts>
must_revalidate=0|1
last_modified=<HTTP-date>
etag=<ETag>
```

Если заголовки `Cache-Control`/`Expires` не заданы, объект считается устаревшим и требует валидации.

## Валидация кэша

Прокси учитывает следующие заголовки:

- `Cache-Control: no-store` — ответ не кэшируется.
- `Cache-Control: no-cache` / `must-revalidate` — объект сохраняется, но всегда требует валидации.
- `Cache-Control: max-age=N` — срок годности вычисляется как `now + N`.
- `Expires` — используется при отсутствии `max-age`.
- `Last-Modified` и `ETag` — сохраняются для условных запросов.

При наличии валидаторов прокси добавляет:

```
If-Modified-Since: <last_modified>
If-None-Match: <etag>
```

## Многопоточная обработка

Каждое входящее подключение обслуживается отдельным потоком `pthread`. Для операций с кэшем используется общий `pthread_mutex`, который защищает чтение/запись метаданных и финализацию файлов кэша.

## Работа с POST

`POST`‑запросы проксируются с передачей тела и заголовков (кроме hop‑by‑hop). Ответы на `POST` не кэшируются, как требует задание.

## Примеры работы и логи

### Запуск

```
./proxy_server 8888 -cache_dir ./cache -d
```

### Пример запроса через curl

```
curl -v -x http://localhost:8888 http://www.example.com/
```

### Пример логов

```
[2025-01-05 12:00:01] INFO: HTTP Proxy запущен на порту 8888
[2025-01-05 12:00:10] INFO: Кэш-промах: http://www.example.com:80/
[2025-01-05 12:00:12] INFO: Кэш-попадание: ./cache/9f1b2c3d4e5f6a7b.cache
[2025-01-05 12:00:20] INFO: Кэш обновлён (304 Not Modified): http://www.example.com:80/
```

### Настройка браузера

- HTTP proxy: `localhost`
- Порт: `8888`

Скриншоты настройки выполняются вручную в браузере (например, в разделе Network/Proxy Settings).

## Обработка ошибок

- Некорректные запросы: `400 Bad Request`.
- Неподдерживаемые методы: `501 Not Implemented`.
- Ошибки соединения/чтения: `502 Bad Gateway`.
- Все сообщения и логи — на русском языке.
